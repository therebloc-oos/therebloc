{% extends 'MSMEOrderingWebApp/customer_base.html' %}
{% load static %}

{% block title %}Customer Reviews{% endblock %}

{% block content %}
 <!-- Google Fonts -->
   <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caudex:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Clash+Grotesk:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Aleo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arapey:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bitter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Brawler:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rokkitt:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


  <style>
    :root {
      --primary-color: {{ customization.primary_color|default:'#3b82f6' }};
      --secondary-color: {{ customization.secondary_color|default:'#1d4ed8' }};
      --accent-color: {{ customization.accent_color|default:'#059669' }};
    }

    body {
        min-height: 100vh;
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
    }


    {% if customization.general_background_type == 'solid' %}
    body {
        background-color: {{ customization.general_solid_color|default:"#ffffff" }};
    }
    {% elif customization.general_background_type == 'gradient' %}
    body {
        background: linear-gradient(
            {{ customization.general_gradient_direction|default:"to right" }},
            {{ customization.general_gradient_color_1|default:"#ffffff" }},
            {{ customization.general_gradient_color_2|default:"#000000" }}
            {% if customization.general_gradient_color_3 %}
                , {{ customization.general_gradient_color_3 }}
            {% endif %}
        );
    }
    {% elif customization.general_background_type == 'image' %}
    body {
        background-image: url("{{ customization.general_background_image.url }}");
    }
    {% endif %}



    .container-fluid{
      padding: 0%;
    }

    .reviews-header {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(20px);
      font-family: {{ customization.header_font_family|default:"Arial" }};
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      border: 3px solid var(--accent-color);
    }

    .star-rating {
      display: flex;
      direction: row-reverse;
      justify-content: flex-end;
      gap: 2px;
    }
    
    .star-rating input {
      display: none;
    }
    
    .star-rating label {
      cursor: pointer;
      color: #ddd;
      transition: color 0.3s ease;
      font-size: {% if customization.header_font_size and customization.header_font_size|add:'0' <= 30 %}{{ customization.header_font_size|default:20 }}{% else %}30{% endif %}px;

    }
    
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #ffc107;
    }
    
    .star-rating input:checked ~ label {
      color: #ffc107;
    }
    
    .star-display {
      display: flex;
      gap: 2px;
      margin-bottom: 8px;
    }
    
    .star-display .fa-star {
      color: #ffc107;
    }
    
    .star-display .far {
      color: #ddd;
    }

      .rating-summary {
        position: relative;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.575);
        color: white;
        margin-bottom: 30px;
      }


    .rating-summary h3 {
      margin-bottom: 10px;
      font-family: '{{ customization.header_font_family|default:"Arial" }}';
      font-size: {% if customization.header_font_size and customization.header_font_size|add:'0' <= 45 %}{{ customization.header_font_size|default:20 }}{% else %}45{% endif %}px;
      font-weight: {% if customization.header_font_style == 'bold' or customization.header_font_style == 'bolditalic' %}800{% else %}normal{% endif %};
      font-style: {% if customization.header_font_style == 'italic' or customization.header_font_style == 'bolditalic' %}italic{% else %}normal{% endif %};
        
    }

    .rating-summary .star-display i {
      font-size: 1.5rem;
      margin: 0 2px;
      color: #ffc107;
    }

    .rating-summary small {
      display: block;      
      color: #f1f1f1;
    }

    #ratingBars .d-flex {
      align-items: center;
    }

    #ratingBars span {
      font-size: 0.9rem;
      font-weight: 600;
      color: #000000;
    }

    #ratingBars .progress {
      background-color: rgba(102, 102, 102, 0.062);
      height: 10px;
      border-radius: 5px;
    }

    #ratingBars .progress-bar {
      background-color: #ffc107;
      border-radius: 5px;
    }

    
    .review-card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      padding: 20px;
      border-top: 2px solid var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .review-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.466);
    }
    
    .review-header {
      display: flex;
      align-items-start;
      gap: 15px;
      font-weight: 600;
      margin-bottom: 5px;
      font-family: {{ customization.header_font_family|default:"Montserrat" }};
      color: {{ customization.header_font_color|default:"#000000" }};
    }
    
    .profile-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #f8f9fa;
    }
    
    .review-info h6 {
      font-family: {{ customization.body_font_family|default:"Montserrat" }};
      color: {{ customization.body_font_color|default:"#000000" }};
      margin: 0;
      font-weight: 600;
    }
    
    .review-date {
      color: #6c757d;
      font-weight: 500;
      font-family: {{ customization.body_font_family|default:"Montserrat" }};
      font-size: {% if customization.body_font_size and customization.body_font_size|add:'0' <= 13 %}{{ customization.body_font_size|default:10 }}{% else %}13{% endif %}px;

    }
    
    .review-text {
      font-weight: 600;
      line-height: 1.6;
      margin: 10px 0;
      font-family: {{ customization.body_font_family|default:"Montserrat" }};
      color: {{ customization.body_font_color|default:"#000000" }};
      font-size: {% if customization.body_font_size and customization.body_font_size|add:'0' <= 16 %}{{ customization.body_font_size|default:12 }}{% else %}16{% endif %}px;
    }

    .owner-response {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
      font-weight: 600;
      border-left: 5px solid var(--primary-color);
      font-family: '{{ customization.body_font_family|default:"Montserrat" }}';
      font-size: {% if customization.body_font_size and customization.body_font_size|add:'0' > 16 %}16
      {% else %}{{ customization.body_font_size|default:14 }}{% endif %}px;
      color: {{ customization.body_font_color|default:"#000000" }};
    }
    
    .owner-response-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 700;
      font-family: "{{ customization.header_font_family|default:"Arial" }}";
      color: {{ customization.header_font_color|default:"#000000" }};
    }

    .owner-response-header h6 {
      margin: 0;
      font-weight: 600;
      font-family: "{{ customization.header_font_family|default:"Arial" }}";
      color: {{ customization.header_font_color|default:"#000000" }};
      font-size: {% if customization.header_font_size and customization.header_font_size|add:'0' > 20 %}20
      {% else %}{{ customization.header_font_size|default:16 }}{% endif %}px;
    }
    
    .owner-response-icon {
      background: transparent;
      color: white;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 5px;
      font-size: 30px;
    }
    
    .reviews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .reviews-title {
      display: flex;
      align-items: center;
      gap: 1rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);    
      color: {{ customization.header_font_color|default:"#000000" }};   
      font-family: "{{ customization.header_font_family|default:"Arial" }}";
      font-size: {% if customization.header_font_size and customization.header_font_size|add:'0' > 40 %}40{% else %}{{ customization.header_font_size|default:24 }}{% endif %}px;
      font-weight: {% if customization.header_font_style == 'bold' or customization.header_font_style == 'bolditalic' %}800{% else %}normal{% endif %};
      font-style: {% if customization.header_font_style == 'italic' or customization.header_font_style == 'bolditalic' %}italic{% else %}normal{% endif %};
    }
    
    .btn-add-review {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      transition: transform 0.2s ease;
      font-family: {{ customization.header_font_family|default:"Montserrat" }};
      color: {{ customization.button_text_color|default:'#ffffff' }};
      border-radius: {{ customization.button_rounded_corner|default:1 }}px;
    }
    
    .btn-add-review:hover {
      transform: translateY(-2px);
      color: {{ customization.button_text_color|default:'#ffffff' }};
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
    }
    
    /* Modal Container Styling */
    .modal-content {
      border-radius: 16px;
      border: none;
      background-color: #fff;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      font-family: {{ customization.body_font_family|default:"Montserrat" }};
    }


    /* Modal Header */
    .modal-header {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 12px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    /* Modal Title */
    .modal-title {
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: {% if customization.header_font_size and customization.header_font_size|add:'0' <= 25 %}{{ customization.header_font_size|default:20 }}{% else %}25{% endif %}px;
      font-family: '{{ customization.header_font_family|default:"Arial" }}';
      color: {{ customization.button_text_color|default:'#ffffff' }};
    }

    /* Close Button */
    .btn-close {
      background-color: transparent;
      color: {{ customization.button_text_color|default:'#ffffff' }};
    }
    .btn-close:hover {
      opacity: 1;
    }

    /* Star Rating Inside Modal */
    .star-rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-end;
      gap: 5px;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      font-size: 2rem;
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #ffc107;
    }

    .star-rating input:checked ~ label {
      color: #ffc107;
    }

    /* Review Textarea */
    #reviewInput {
      resize: vertical;
      border-radius: 8px;
      border: 2px solid var(--primary-color);
      transition: border-color 0.2s;
    }

    #reviewInput:focus {
      border-color: var(--secondary-color);
      box-shadow: none;
    }

    /* Anonymous Checkbox */
    .form-check-label i {
      color: var(--primary-color);
    }

    /* Modal Footer Buttons */
    .modal-footer .btn {
      border-radius: 8px;
      font-weight: 600;
    }

    .modal-footer .btn-primary {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      border: none;
      padding: 10px 20px;
      font-weight: 600;
      transition: transform 0.2s ease;
      font-family: {{ customization.header_font_family|default:"Montserrat" }};
      color: {{ customization.button_text_color|default:'#ffffff' }};
      border-radius: {{ customization.button_rounded_corner|default:1 }}px;
    }

    .modal-footer .btn-primary:hover {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      color: {{ customization.button_text_color|default:'#ffffff' }};

    }
 
    .search-sort-container {
      position: sticky;
      top: 65px; /* adjust depending on your header height */
      z-index: 100; /* keeps it above other elements */
      font-family: {{ customization.header_font_family|default:"Montserrat" }};
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(20px);
      padding: 25px 30px;
      border-radius: 16px;
      border: 2px solid var(--primary-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .search-sort-container .input-group {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      transition: border-color 0.2s ease;
    }

    .search-sort-container .form-control,
    .search-sort-container .form-select {
      border-radius: 8px;
      box-shadow: none;
      border: 2px solid var(--primary-color);
      transition: border-color 0.2s ease;
    }

    .search-sort-container .form-control:focus,
    .search-sort-container .form-select:focus {
      border-color: var(--secondary-color);
    }
    
    .input-group-text {
      background-color: #ffffff;
      border: 2px solid var(--primary-color);
      border-right: none;
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000000;
      font-size: 1rem;
      transition: all 0.2s ease-in-out;
    }

    /* Hover effect */
    .input-group-text:hover {
      background-color: var(--primary-color);
      color: #ffffff;
    }

    /* Focus effect when input is active */
    .input-group:focus-within .input-group-text {
      background-color: var(--primary-color);
      color: #ffffff;
    }


    .input-group-text:focus {
      border: 2px solid var(--secondary-color);
      border-right: none;
    }  

    .input-group-text i {
      color: var(--primary-color);;
      font-size: 1rem;
      transition: color 0.3s ease;
    }

    .input-group:focus-within .input-group-text i {
      color: var(--secondary-color);
    }

    
    .rating-summary {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(20px);
      font-weight: 700;
      font-family: {{ customization.header_font_family|default:"Montserrat" }};
      color: {{ customization.header_font_color|default:"#000000" }};
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
      margin-bottom: 25px;
    }
    
    .no-reviews {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    
    .no-reviews i {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #dee2e6;
    }
    
    .default-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
    }

    /* Review Photos Thumbnails */
    .review-photos {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .review-photos a {
      display: inline-block;
      border-radius: 8px;
      overflow: hidden;
      transition: box-shadow 0.2s, transform 0.2s;
      border: 1.5px solid #eee;
    }

    .review-photos a:hover img {
      box-shadow: 0 4px 16px rgba(0,0,0,0.18);
      transform: scale(1.05);
      border-color: var(--primary-color);
    }

    .review-photos img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
    }

  .photo-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
  }

  .close-btn {
    position: absolute;
    top: 30px;
    right: 40px;
    font-size: 40px;
    color: white;
    cursor: pointer;
  }

  .prev-btn, .next-btn {
    display: none;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 2.5rem;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    z-index: 10001;
  }

  .prev-btn {
    left: 40px;
  }

  .next-btn {
    right: 40px;
  }

  .modal-img {
    max-width: 90vw;
    max-height: 90vh;
    display: block;
    margin: auto;
    border-radius: 12px;
    box-shadow: 0 0 20px #000;
  }

  /* Responsive alignment for Add Review button */
  @media (max-width: 768px) {
    .reviews-header {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }

    .reviews-title {
      font-size: 22px;
      margin-bottom: 10px;
    }

    .btn-add-review {
      margin-left: auto;
      margin-top: 0;
      width: auto;
      padding: 8px 16px;
      font-size: 14px;
    }
  }

  @media (max-width: 400px) {
    .reviews-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .btn-add-review {
      margin-left: 0;
      margin-top: 10px;
      width: 100%;
    }
  }

  .empty-state{
    opacity:0.6;
    
  }
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(20px);
    font-family: {{ customization.header_font_family|default:"Arial" }};
  }


  .empty-icon {
    font-size: 60px;
    margin-bottom: 15px;
    color: {{ customization.header_font_color|default:"#000000" }};

  }

  .empty-state h4 {
      color: {{ customization.header_font_color|default:"#000000" }};
      font-family: '{{ customization.header_font_family|default:"Arial" }}';
      font-size: {% if customization.header_font_size and customization.header_font_size|add:'0' <= 45 %}{{ customization.header_font_size|default:20 }}{% else %}45{% endif %}px;
      font-weight: {% if customization.header_font_style == 'bold' or customization.header_font_style == 'bolditalic' %}800{% else %}normal{% endif %};
      font-style: {% if customization.header_font_style == 'italic' or customization.header_font_style == 'bolditalic' %}italic{% else %}normal{% endif %};
  }
   
  .empty-state p {
        font-weight: 600;
        font-size: {% if customization.body_font_size and customization.body_font_size|add:'0' <= 16 %}{{ customization.body_font_size|default:10 }}{% else %}16{% endif %}px;
  } 

  @media (max-width: 576px) {
    .empty-state {
      padding: 40px 15px;
    }

    .empty-icon {
      font-size: 45px;
    }

    .empty-state h4 {
      font-size: 16px;
    }
  }


</style>

<div class="container-fluid">
  <!-- Header -->
  <div class="reviews-header">
    <h2 class="reviews-title">
      <i class="fas fa-star text-warning me-2"></i>
      Customer Reviews
    </h2>
    <button type="button" class="btn btn-primary btn-add-review" data-bs-toggle="modal" data-bs-target="#reviewModal">
      <i class="fas fa-plus me-2"></i>Add a Review
    </button>
  </div>


  <!-- Rating Summary -->
  {% if reviews %}
  <div class="rating-summary">
    <div class="row justify-content-center">
      <div class="col-xl-4 col-lg-6 col-md-6 text-center">
        <h3 class="mb-1" id="avgRating">4.5</h3>
        <div class="star-display justify-content-center mb-2" id="avgStars">
          <!-- Stars will be populated by JavaScript -->
        </div>
        <small class="text-muted">Average Rating</small>
      </div>
      <div class="col-md-8">
        <div id="ratingBars">
          <!-- Rating bars will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
  {% endif %}

    <!-- Search and Sort Controls -->
  <div class="search-sort-container">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" id="searchReviews" class="form-control border-start-0" placeholder="Search by customer name or content...">
        </div>
      </div>
      <div class="col-md-3">
        <select id="sortReviews" class="form-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="filterStars" class="form-select">
          <option value="all">All Ratings</option>
          <option value="5">5 Stars</option>
          <option value="4">4 Stars</option>
          <option value="3">3 Stars</option>
          <option value="2">2 Stars</option>
          <option value="1">1 Star</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">
            <i class="fas fa-star text-warning me-2"></i>Write a Review
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form method="post" action="{% url 'customer_reviews' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-4">
              <label class="form-label fw-semibold">Rating</label>
              <div class="star-rating">
                <input type="radio" name="rating" id="star5" value="5" required>
                <label for="star5" class="fas fa-star"></label>
                <input type="radio" name="rating" id="star4" value="4" required>
                <label for="star4" class="fas fa-star"></label>
                <input type="radio" name="rating" id="star3" value="3" required>
                <label for="star3" class="fas fa-star"></label>
                <input type="radio" name="rating" id="star2" value="2" required>
                <label for="star2" class="fas fa-star"></label>
                <input type="radio" name="rating" id="star1" value="1" required>
                <label for="star1" class="fas fa-star"></label>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="reviewInput" class="form-label fw-semibold">Your Review</label>
              <textarea name="review" id="reviewInput" class="form-control" rows="4" placeholder="Share your experience..." required></textarea>
            </div>

            <div class="mb-3">
              <label for="reviewPhotos" class="form-label fw-semibold">Photo Review (up to 3 photos)</label>
              <input type="file" name="photos" id="reviewPhotos" class="form-control" accept="image/*" multiple onchange="limitFiles(this)">
              <small class="text-muted">Add up to 3 photos to show your experience with the product.</small>
            </div>
            
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="anonymous" id="anonymousCheck">
              <label class="form-check-label" for="anonymousCheck">
                <i class="fas fa-user-secret me-2"></i>Post Anonymously
              </label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane me-2"></i>Submit Review
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Reviews Display -->
   <!-- Reviews Display -->
<div class="reviews-section">    
  {% if reviews %}
    <div id="reviewsContainer">
      {% for review in reviews %}
        <div class="review-card {% if review.is_hidden %}hidden-review{% endif %}" 
            data-id="{{ review.id }}" 
            data-rating="{{ review.rating|default:0 }}" 
            data-date="{{ review.submitted_at|date:'c' }}"
            data-customer="{{ review.name|lower }}"
            data-content="{{ review.review|lower }}">
          
          <div class="d-flex align-items-start">
            <!-- Profile Image / Avatar -->
            <div class="flex-shrink-0 me-3">
              {% if review.anonymous %}
                <div class="default-avatar">A</div>
              {% else %}
                {% if review.user and review.user.image %}
                  <img src="{{ review.user.image.url }}" 
                      alt="{{ review.user.first_name }} {{ review.user.last_name }}" 
                      class="profile-img" 
                      style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                {% else %}
                  {% if review.user %}
                    <div class="default-avatar">{{ review.user.first_name|first|upper }}</div>
                  {% else %}
                    <div class="default-avatar" style="width:40px; height:40px; border-radius:50%; background-color:#ccc; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px;">
                      {{ review.name|first|upper }}
                    </div>
                  {% endif %}
                {% endif %}
              {% endif %}
            </div>

            <!-- Review Content -->
            <div class="flex-grow-1">
              <div class="review-info">
                <div class="review-header">
                  {% if review.anonymous %}
                    Anonymous User
                  {% else %}
                    {% if review.user %}
                      {{ review.user.first_name }} {{ review.user.last_name }}
                    {% else %}
                      {{ review.name }}
                    {% endif %}
                  {% endif %}
                </div>

                <!-- Rating Stars -->
                <div class="rating-stars mb-2">
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}
                            <i class="fas fa-star text-warning"></i>
                        {% else %}
                            <i class="far fa-star text-warning"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="review-date">{{ review.submitted_at|timesince }} ago</span>
              </div>

              <!-- Review Text -->
              <p class="review-text">{{ review.review }}</p>

              <!-- Review Photos -->
              {% if review.photos.all %}
                <div class="review-photos">
                  {% for photo in review.photos.all %}
                    <a href="#" onclick="showPhotoModal({{ review.photos.all|length }}, {{ forloop.counter0 }}, [{% for p in review.photos.all %}'{{ p.image.url }}'{% if not forloop.last %}, {% endif %}{% endfor %}]); return false;">
                      <img src="{{ photo.image.url }}" alt="Photo Review">
                    </a>
                  {% endfor %}
                </div>
              {% endif %}

              <!-- Order Items -->
              {% if review.order_items %}
                <div class="order-items-badge">
                  <i class="fas fa-shopping-bag me-1"></i>
                  Items: {{ review.order_items }}
                </div>
              {% endif %}

              <!-- Owner Response -->
              {% if review.owner_response %}
                <div class="owner-response">
                  <div class="owner-response-header">
                    <div class="owner-response-icon">
                        {% if business and business.logo %}
                            <img src="{{ business.logo.url }}" alt="Logo" class="logo-img" style="height: 30px; width: 30px; object-fit: cover; border-radius: 50%;" />
                        {% else %}
                            <img src="{% static 'images/logo.png' %}" alt="Logo" class="logo-img" style="height: 30px; width: 30px; object-fit: cover; border-radius: 50%;" />
                        {% endif %}
                    </div>
                    <h6>
                        {% if business and business.business_name %}
                            {{ business.business_name }}
                        {% else %}
                            Owner Response
                        {% endif %}
                    </h6>
                  </div>
                  <p class="mb-2">{{ review.owner_response }}</p>
                  <small class="text-muted">{{ review.response_date|timesince }} ago</small>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-comments"></i>
      </div>
      <h4>No reviews yet</h4>
      <p>Share your experience and help others decide!</p>
    </div>
  {% endif %}
</div>


<div id="photoModal" class="photo-modal">
  <span onclick="closePhotoModal()" class="close-btn">&times;</span>
  <button id="prevPhotoBtn" onclick="prevPhoto()" class="prev-btn">&#8592;</button>
  <img id="modalImg" src="" class="modal-img">
  <button id="nextPhotoBtn" onclick="nextPhoto()" class="next-btn">&#8594;</button>
</div>


<script>

  let photoList = [];
  let photoIndex = 0;

  function showPhotoModal(total, index, photos) {
    photoList = photos;
    photoIndex = index;
    updatePhotoModal();
    document.getElementById('photoModal').style.display = 'flex';
  }

  function updatePhotoModal() {
    document.getElementById('modalImg').src = photoList[photoIndex];
    // Show/hide navigation buttons
    document.getElementById('prevPhotoBtn').style.display = (photoList.length > 1 && photoIndex > 0) ? 'block' : 'none';
    document.getElementById('nextPhotoBtn').style.display = (photoList.length > 1 && photoIndex < photoList.length - 1) ? 'block' : 'none';
  }

  function closePhotoModal() {
    document.getElementById('photoModal').style.display = 'none';
  }

  function prevPhoto() {
    if (photoIndex > 0) {
      photoIndex--;
      updatePhotoModal();
    }
  }

  function nextPhoto() {
    if (photoIndex < photoList.length - 1) {
      photoIndex++;
      updatePhotoModal();
    }
  }

  // Close modal when clicking outside the image
  window.onclick = function(event) {
    var modal = document.getElementById('photoModal');
    if (event.target == modal) {
      closePhotoModal();
    }
  }

  /*
  function limitFiles(input) {
    if (input.files.length > 3) {
      alert("You can upload up to 3 photos only.");
      input.value = "";
    }
  }
  */

  // ✅ Automatically compress images to ≤ 500 KB
  async function limitFiles(input) {
    const maxFiles = 3;
    const maxSize = 500 * 1024; // 500 KB
    const files = Array.from(input.files);

    if (files.length > maxFiles) {
      alert("You can upload up to 3 photos only.");
      input.value = "";
      return;
    }

    const compressedFiles = [];

    for (const file of files) {
      if (!file.type.startsWith("image/")) {
        alert(`${file.name} is not an image file.`);
        input.value = "";
        return;
      }

      const compressed = await compressImage(file, maxSize);
      compressedFiles.push(compressed);
    }

    // Replace FileList inside input
    const dataTransfer = new DataTransfer();
    compressedFiles.forEach(f => dataTransfer.items.add(f));
    input.files = dataTransfer.files;

  }

  // ✅ Image compression helper
  function compressImage(file, maxSize) {
    return new Promise((resolve) => {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = function (e) {
        img.src = e.target.result;
      };

      img.onload = function () {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        const maxWidth = 1280; // optional resize
        const scale = Math.min(maxWidth / img.width, 1);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        let quality = 0.9;
        let result = canvas.toDataURL("image/jpeg", quality);

        // Iteratively reduce quality until size ≤ 500 KB
        while (result.length > maxSize * 1.33 && quality > 0.1) {
          quality -= 0.05;
          result = canvas.toDataURL("image/jpeg", quality);
        }

        // Convert back to File object
        fetch(result)
          .then(res => res.blob())
          .then(blob => {
            resolve(new File([blob], file.name.replace(/\.[^/.]+$/, ".jpg"), { type: "image/jpeg" }));
          });
      };

      reader.readAsDataURL(file);
    });
  }


  document.addEventListener('DOMContentLoaded', function() {
      const reviewCards = document.querySelectorAll('.review-card');
      const searchInput = document.getElementById('searchReviews');
      const sortSelect = document.getElementById('sortReviews');
      const filterSelect = document.getElementById('filterStars');
      const container = document.getElementById('reviewsContainer');

      // Calculate and display rating summary
      function updateRatingSummary() {
          if (reviewCards.length === 0) return;
          
          const ratings = Array.from(reviewCards)
          .map(card => parseInt(card.dataset.rating))
          .filter(rating => !isNaN(rating));

          const avgRating = (ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length).toFixed(1);
          
          // Update average rating display
          const avgRatingElement = document.getElementById('avgRating');
          if (avgRatingElement) {
              avgRatingElement.textContent = avgRating;
          }
          
          // Update average stars
          const avgStarsContainer = document.getElementById('avgStars');
          if (avgStarsContainer) {
              const fullStars = Math.floor(avgRating);
              const hasHalf = avgRating % 1 >= 0.5;
              
              avgStarsContainer.innerHTML = '';
              for (let i = 1; i <= 5; i++) {
                  const star = document.createElement('i');
                  if (i <= fullStars) {
                      star.className = 'fas fa-star';
                  } else if (i === fullStars + 1 && hasHalf) {
                      star.className = 'fas fa-star-half-alt';
                  } else {
                      star.className = 'far fa-star';
                  }
                  avgStarsContainer.appendChild(star);
              }
          }
          
          // Update rating bars
          const ratingCounts = [0, 0, 0, 0, 0];
          ratings.forEach(rating => ratingCounts[rating - 1]++);
          
          const barsContainer = document.getElementById('ratingBars');
          if (barsContainer) {
              barsContainer.innerHTML = '';
              
              for (let i = 5; i >= 1; i--) {
                  const count = ratingCounts[i - 1];
                  const percentage = ratings.length > 0 ? (count / ratings.length * 100) : 0;
                  
                  const barHTML = `
                      <div class="d-flex align-items-center mb-1">
                          <span class="me-2" style="min-width: 60px;">${i} stars</span>
                          <div class="progress flex-grow-1 me-2" style="height: 8px;">
                              <div class="progress-bar bg-warning" style="width: ${percentage}%"></div>
                          </div>
                          <span class="text-muted" style="min-width: 30px;">${count}</span>
                      </div>
                  `;
                  barsContainer.innerHTML += barHTML;
              }
          }
      }

      // Search functionality
      if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const reviewCards = document.querySelectorAll('.review-card');
            
            reviewCards.forEach(function(card) {
                // Review text
                const reviewText = card.querySelector('.review-text')?.textContent.toLowerCase() || '';

                // Customer name (works for both logged-in and guest users)
                const customerName = card.querySelector('.review-header')?.textContent.toLowerCase() || '';

                // Match search against both
                if (reviewText.includes(searchTerm) || customerName.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
      }


      // Filter by stars
      if (filterSelect) {
          filterSelect.addEventListener('change', function() {
              const filterValue = this.value;
              reviewCards.forEach(card => {
                  if (filterValue === 'all' || card.dataset.rating === filterValue) {
                      card.style.display = 'block';
                  } else {
                      card.style.display = 'none';
                  }
              });
          });
      }

      // Sort functionality
      if (sortSelect && container) {
          sortSelect.addEventListener('change', function() {
              const cards = Array.from(reviewCards);
              const sortBy = this.value;
              
              cards.sort((a, b) => {
                  const ratingA = parseInt(a.dataset.rating) || 5;
                  const ratingB = parseInt(b.dataset.rating) || 5;
                  const dateA = Date.parse(a.dataset.date) || 0;
                  const dateB = Date.parse(b.dataset.date) || 0;

                  if (sortBy === 'newest') return dateB - dateA;
                  if (sortBy === 'oldest') return dateA - dateB;
                  if (sortBy === 'highest') return ratingB - ratingA;
                  if (sortBy === 'lowest') return ratingA - ratingB;
                  return 0;
              });
              
              cards.forEach(card => container.appendChild(card));
          });
      }

      // Initialize rating summary
      updateRatingSummary();

      // Star rating interaction in modal
      const starLabels = document.querySelectorAll('.star-rating label');
      starLabels.forEach(label => {
          label.addEventListener('mouseenter', function() {
              const rating = this.getAttribute('for').replace('star', '');
              starLabels.forEach((l, index) => {
                  if (5 - index <= rating) {
                      l.style.color = '#ffc107';
                  } else {
                      l.style.color = '#ddd';
                  }
              });
          });
      });

      const starRating = document.querySelector('.star-rating');
      if (starRating) {
          starRating.addEventListener('mouseleave', function() {
              const checkedInput = document.querySelector('.star-rating input:checked');
              if (checkedInput) {
                  const rating = checkedInput.value;
                  starLabels.forEach((l, index) => {
                      if (5 - index <= rating) {
                          l.style.color = '#ffc107';
                      } else {
                          l.style.color = '#ddd';
                      }
                  });
              } else {
                  starLabels.forEach(l => l.style.color = '#ddd');
              }
          });
      }
  });

  // Prevent multiple form submissions and show loading state
  document.addEventListener("DOMContentLoaded", function () {
    const reviewForm = document.querySelector('#reviewModal form');
    const submitBtn = reviewForm?.querySelector('button[type="submit"]');

    if (reviewForm && submitBtn) {
      reviewForm.addEventListener("submit", function () {
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Submitting...
        `;
      });
    }
  });

</script>

{% endblock %}
